# 单终端登录系统设计

## 需求说明
系统分为客户端和服务端，客户端包括Android、iOS两大平台，为用户提供账号注册、登录功能。同时限定每个账号同一时间只能在单个终端设备进行登录，切换设备登录时，其他已登录的终端将被踢出。

## 设计思路
为简单起见，本系统仅支持用户名、密码登录，且用户名在系统中唯一。

设计账号模块考虑的几个重点问题：
1. 安全性保障，包括数据传输安全、存储安全和接口安全
2. 单终端登录控制逻辑
3. 保障模块的高可用性
4. 系统运行状态监控机制

### 模块安全性

#### 数据传输安全
第一个原则是不在网络上传输用户的明文密码，需要在客户端进行不可逆加密后再上传给服务端。
第二个原则是使用安全的网络连接，如HTTPS，gRPC with TLS/SSL，这可以很大程度上避免数据在传输过程中被别人抓包破解。

#### 数据存储安全
第一原则还是不存储用户的明文密码，也不直接存储客户端上传上来的密码。而是进行二次加盐加密。同时，每个用户所使用的盐保证是唯一的，并避免盐值的长度太短。这样即使数据被泄漏，也可以避免黑客直接获取用户的密码，同时因为在对每个用户密码进行加密时，采用的盐值都不一样，也可以增大黑客进行暴力破解的成本。

#### 服务接口安全
服务接口安全，有两个方面，一是防范各种SQL注入等攻击，需要对客户端上传的参数一定做好必要的校验。  
二是接口协议的安全，避免黑客修改正常的请求数据来模拟接口调用，或者使用重放攻击等手段获取信息。可以通过在接口协议中增加timestamp，nonce，sign字段来避免。timestamp为客户端发起接口调用时的时间戳，服务端只接收距离当前时间一定范围内的请求（如5分钟内）。nonce为一个随机字符串，服务端记录一段时间内（如5分钟）已接收到的nonce值，在接下来的请求中，服务端会检查请求的nonce字段，判断之前是否已经使用过。sign字段用来对整个请求的参数进行签名，客户端和服务端采用同样的方法计算sign值，并比对两者的计算结果是否相同。

#### 单终端登录控制
账号每次登录成功后，给客户端下发一个token，用于后续的接口调用。服务端通过对token进行校验来对用户进行认证。
可以将这个下发的token和终端的设备号deviceId进行关联来控制单终端登录，流程如下：
1. 客户端调用登录接口，带上userName, password, deviceId信息。
2. 服务端校验userName和password是否正确，如果正确，往下执行。
3. 检查此账号是否存在一个正在使用的token记录（用token_old来表示），如果没有，跳到步骤7
4. 取出token_old，以及关联的设备号deviceId_old.
5. 将token_old标记为不可用状态，并判断deviceId_old与此次登录所使用的设备号deviceId是否相同，如果相同，跳到步骤7
6. 通过deviceId_old，往设备推送一条push消息，客户端接收到之后自动删除本地缓存的账号信息，并提示用户
7. 生成新的token记录，标记为可用，并于新上传的设备号deviceId管理，保存。
8. 返回客户端登录结果。

步骤6中，使用了消息推送的方式将账号登录状态被踢出的信息下发给客户端。如果客户端和服务端没有维持消息推送通道，则可以通过其他方式通知到用户，如手机短信、邮件等，或者等用户使用老的token进行接口调用时，返回特定的错误码。

其中，设备号的生成，在Android端可以综合手机的mac地址、蓝牙地址、IMEI号等参数进行拼接生成，并保持在应用未被卸载的状态下是一致的。


#### 模块可用性保障
##### 增加服务负载均衡策略
简单的做法是增加一个负载均衡服务器LB，由LB来代理所有的客户端调用。LB根据后端服务的负载状态来路由客户端的调用。
更进一步的做法是，让客户端一起参与到负载均衡的策略中，避免上述方案中LB成为整个系统的瓶颈。具体可以参考：[gRPC的负载均衡应用场景](https://grpc.io/blog/loadbalancing)

此外，还应考虑数据库的可用性以及数据缓存问题。

#### 系统运行状态监控机制
在此系统内，可以考虑对接口的吞吐量、响应时长、服务器可用性、负载状态等指标进行监控，触发报警阈值时，自动发出报警信息。

## 数据传输方案
在本系统实现时，后端采用gRPC框架来实现。因此数据传输的安全性，使用gRPC with TLS/SSL进行保障。
> 当前版本gRPC的SSL配置暂未完成

注册接口和登录接口，除接口名称不一样外，其请求和响应参数相同，如下：
参数 | 是否必须 | 含义
---|---|---
userName | 是 | 用户名
pwdHash | 是 | 客户端对用户密码的加盐hash结果
device | 是 | 终端的设备号
响应参数如下：
参数 | 含义
--- | ---
err | 错误码
msg | 错误描述
token | token信息，注册成功时下发

客户端对密码进行hash的策略如下：
```
pwdHash = sha256(password + salt + userName)
```
其中，salt取值为一个预设的随机字符串。

> 接口协议安全控制此版本暂未添加

## 数据存储方案
采用MySQL进行数据存储。用两张表来存储用户信息：

用户表的结构如下：
字段 | 含义 | 类型 | 备注
--- | --- | --- | ---
uid | 自增的用户id | bigint | -
user_name | 用户名 | varchar(255) | 全局唯一
pwd_hash | 用户hash加密后的密码 | varchar(64) | -
salt | 用于密码hash的盐值 | varchar(255) | 随机生成，全局唯一

token表的结构如下
字段 | 含义 | 类型 | 备注
--- | --- | --- | ---
user_name | 用户名 | varchar(255) | 全局唯一
token | 下发给用户的token | varchar(255) | 全局唯一
status |token的状态值 | int | 限定取值范围
device | 与此token关联的设备号 | varchar(255) | -

服务端对密码进行hash时，会为每个用户生成一个随机的盐值，hash方法为
```
pwd_hash = sha256(password + user_name + salt)
```

## 单终端控制
账号登录后，需要将其他终端的账号强制下线，并下发下线通知。这涉及到消息推送机制。gRPC框架的stream机制可以实现此类效果，但考虑到gPRC的stream机制，需要客户端和服务端保持稳定的连接。这在移动设备上基本不可能实现，所以在实现过程中，借助[腾讯移动推送](https://xg.qq.com/)来实现消息push功能。

## 模块可用性保障方案
> todo

## 项目目录结构
总体结构
```
.
├── client          // 客户端代码
│   ├── android     // Android端实现
│   ├── BUILD
│   ├── interface   // 接口定义文件
│   ├── Makefile        
│   └── native      // C++接口实现
├── doc             // 文档目录
├── LICENSE
├── protos          // gRPC接口定义
├── README.md
├── svr             // 服务端代码
├── third_party     // 项目第三方依赖项
│   ├── curl
│   ├── curl.BUILD
│   ├── djinni
│   ├── grpc
│   ├── mysql-connector
│   └── mysql_connector.BUILD
└── WORKSPACE



```

## 参考文档
1. [打造一个安全的用户名密码登陆系统](https://juejin.im/entry/57a42e59128fe10054721c28)
2. [设计安全的账号系统的正确姿势](https://www.jianshu.com/p/e7d47efc92eb)
3. [Salted Password Hashing - Doing it Right](https://crackstation.net/hashing-security.htm)
4. [Mobile API Security Techniques](https://hackernoon.com/mobile-api-security-techniques-682a5da4fe10)